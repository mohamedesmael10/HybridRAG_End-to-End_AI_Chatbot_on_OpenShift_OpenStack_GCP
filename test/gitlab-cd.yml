stages:
  - trial

deploy_to_osd:
  image: quay.io/openshift/origin-cli:4.13
  stage: trial
  variables:
    HELM_TIMEOUT: "10m"
    OS_PROJECT: "mohamed-esmael-dev"
    OS_ADMIN_PROJECT: "mohamed-esmael-dev"

  before_script:
    # install Helm v3
    - curl -fsSL https://get.helm.sh/helm-v3.12.0-linux-amd64.tar.gz -o helm.tgz
    - tar -xzf helm.tgz && mv linux-amd64/helm /usr/local/bin/helm && chmod +x /usr/local/bin/helm
    - helm version
  script:
    - set -euo pipefail

    - echo "Login to OpenShift..."
    - oc login --token="$OC_TOKEN" --server="$OC_SERVER" --insecure-skip-tls-verify=true

    # ensure project(s)
    - export NAMESPACE_USER="${OS_PROJECT:-mohamed-esmael-dev}"
    - export NAMESPACE_ADMIN="${OS_ADMIN_PROJECT:-mohamed-esmael-dev}"
    - oc project "$NAMESPACE_USER"  || true
    - oc project "$NAMESPACE_ADMIN" || true

    
    # -------------------------
    # OPTIONAL: create/update GCP service-account secret (kept for LLM access if you still need it)
    # -------------------------
    - |
      if [ -n "${GCP_SA_KEY:-}" ]; then
        echo "Creating/updating OpenShift secret 'service-account.json' from CI var GCP_SA_KEY..."
        TMPFILE="$(mktemp /tmp/gcp-sa.XXXXXX)"
        if echo "$GCP_SA_KEY" | base64 --decode > "$TMPFILE" 2>/dev/null; then
          echo "GCP_SA_KEY decoded from base64 (hidden)."
        else
          echo "GCP_SA_KEY appears not base64; writing raw content to temp file."
          echo "$GCP_SA_KEY" > "$TMPFILE"
        fi
        # quick JSON validation (if python present)
        if command -v python3 >/dev/null 2>&1; then
          if ! python3 -c "import json,sys; json.load(open('$TMPFILE'))" 2>/dev/null; then
            echo "ERROR: service-account JSON is invalid"; rm -f "$TMPFILE"; exit 1
          fi
        elif command -v python >/dev/null 2>&1; then
          if ! python -c "import json,sys; json.load(open('$TMPFILE'))" 2>/dev/null; then
            echo "ERROR: service-account JSON is invalid"; rm -f "$TMPFILE"; exit 1
          fi
        fi
        oc delete secret service-account.json -n "$NAMESPACE_USER" --ignore-not-found || true
        oc create secret generic service-account.json -n "$NAMESPACE_USER" --from-file=service-account.json="$TMPFILE"
        oc delete secret service-account.json -n "$NAMESPACE_ADMIN" --ignore-not-found || true
        oc create secret generic service-account.json -n "$NAMESPACE_ADMIN" --from-file=service-account.json="$TMPFILE"
        shred -u "$TMPFILE" 2>/dev/null || rm -f "$TMPFILE"
      else
        echo "GCP_SA_KEY not provided â€” skipping service-account secret creation."
      fi

    # -------------------------
    # Resolve Docker images (Docker Hub trial)
    # Accept override env vars:
    # USER_BACKEND_IMAGE, USER_FRONTEND_IMAGE, CHUNK_IMAGE, ADMIN_BACKEND_IMAGE, ADMIN_FRONTEND_IMAGE
    # Fallbacks use your DockerHub images with -v1 tags.
    # -------------------------
    - |
      # defaults (your dockerhub images)
      DEFAULT_USER_BACKEND="mohamedesmael/hybridrag_end-to-end_ai_chatbot_on_openshift_openstack_gcp:user-backend-v2"
      DEFAULT_USER_FRONTEND="mohamedesmael/hybridrag_end-to-end_ai_chatbot_on_openshift_openstack_gcp:user-frontend-v7"
      DEFAULT_CHUNK="mohamedesmael/hybridrag_end-to-end_ai_chatbot_on_openshift_openstack_gcp:chunk-image-v1"
      DEFAULT_ADMIN_BACKEND="mohamedesmael/hybridrag_end-to-end_ai_chatbot_on_openshift_openstack_gcp:admin-backend-v2"
      DEFAULT_ADMIN_FRONTEND="mohamedesmael/hybridrag_end-to-end_ai_chatbot_on_openshift_openstack_gcp:admin-frontend-v3"

      # choose provided or default
      USER_BACKEND_IMAGE="${USER_BACKEND_IMAGE:-${DEFAULT_USER_BACKEND}}"
      USER_FRONTEND_IMAGE="${USER_FRONTEND_IMAGE:-${DEFAULT_USER_FRONTEND}}"
      CHUNK_IMAGE="${CHUNK_IMAGE:-${DEFAULT_CHUNK}}"
      ADMIN_BACKEND_IMAGE="${ADMIN_BACKEND_IMAGE:-${DEFAULT_ADMIN_BACKEND}}"
      ADMIN_FRONTEND_IMAGE="${ADMIN_FRONTEND_IMAGE:-${DEFAULT_ADMIN_FRONTEND}}"

      echo "Resolved images:"
      echo " USER_BACKEND_IMAGE=${USER_BACKEND_IMAGE}"
      echo " USER_FRONTEND_IMAGE=${USER_FRONTEND_IMAGE}"
      echo " CHUNK_IMAGE=${CHUNK_IMAGE}"
      echo " ADMIN_BACKEND_IMAGE=${ADMIN_BACKEND_IMAGE}"
      echo " ADMIN_FRONTEND_IMAGE=${ADMIN_FRONTEND_IMAGE}"

      # helper to split repo and tag; if no tag provided default to 'latest'
      split_repo_tag() {
        full="$1"
        repo="${full%%:*}"
        tag="${full#*:}"
        if [ "$repo" = "$tag" ]; then
          tag="latest"
        fi
        printf "%s|%s" "$repo" "$tag"
      }

      IFS='|' read -r USER_BACKEND_REPO USER_BACKEND_TAG <<< "$(split_repo_tag "$USER_BACKEND_IMAGE")"
      IFS='|' read -r USER_FRONTEND_REPO USER_FRONTEND_TAG <<< "$(split_repo_tag "$USER_FRONTEND_IMAGE")"
      IFS='|' read -r CHUNK_REPO CHUNK_TAG <<< "$(split_repo_tag "$CHUNK_IMAGE")"
      IFS='|' read -r ADMIN_BACKEND_REPO ADMIN_BACKEND_TAG <<< "$(split_repo_tag "$ADMIN_BACKEND_IMAGE")"
      IFS='|' read -r ADMIN_FRONTEND_REPO ADMIN_FRONTEND_TAG <<< "$(split_repo_tag "$ADMIN_FRONTEND_IMAGE")"

      echo "Final repo/tag pairs:"
      echo " user-backend: ${USER_BACKEND_REPO}:${USER_BACKEND_TAG}"
      echo " user-frontend: ${USER_FRONTEND_REPO}:${USER_FRONTEND_TAG}"
      echo " chunk-image: ${CHUNK_REPO}:${CHUNK_TAG}"
      echo " admin-backend: ${ADMIN_BACKEND_REPO}:${ADMIN_BACKEND_TAG}"
      echo " admin-frontend: ${ADMIN_FRONTEND_REPO}:${ADMIN_FRONTEND_TAG}"

    # compute LLM endpoint (kept)
    - |
      LLM_MODEL_ID="${LLM_MODEL_ID:-gemini-2.5-flash}"
      PROJECT_ID="${PROJECT_ID:-$GCP_PROJECT_ID}"
      REGION="${REGION:-us-central1}"
      LLM_ENDPOINT="${LLM_ENDPOINT:-https://us-central1-aiplatform.googleapis.com/v1/projects/${PROJECT_ID}/locations/${REGION}/publishers/google/models/${LLM_MODEL_ID}:generateContent}"
      echo "Using LLM_ENDPOINT=${LLM_ENDPOINT}"

    # -------------------------
    # Deploy user backend (pointing to Docker Hub image)
    # Note: Helm charts should accept image.repository + image.tag values
    # -------------------------
    - |
      helm upgrade --install esmael-user-backend ./helm/user_backend \
        --wait --timeout "$HELM_TIMEOUT" \
        --set image.repository="${USER_BACKEND_REPO}" \
        --set image.tag="${USER_BACKEND_TAG}" \
        --set env.EMBEDDING_ENDPOINT="${EMBEDDING_ENDPOINT:-}" \
        --set env.CHUNK_URL="${CHUNK_URL:-}" \
        --set env.VECTOR_DB_ENDPOINT="${VECTOR_DB_ENDPOINT:-}" \
        --set env.VECTOR_DB_ENDPOINT_UPSERT="${VECTOR_DB_ENDPOINT_UPSERT:-}" \
        --set env.DEPLOYED_INDEX_ID="${DEPLOYED_INDEX_ID:-}" \
        --set env.PROJECT_ID="${PROJECT_ID:-}" \
        --set env.REGION="${REGION:-}" \
        --set env.MEMORY_STORE_HOST="${MEMORY_STORE_HOST:-redis}" \
        --set env.MEMORY_STORE_PORT="${MEMORY_STORE_PORT:-6379}" \
        --set env.LLM_ENDPOINT="${LLM_ENDPOINT}" \
        --set env.LLM_MODEL_ID="${LLM_MODEL_ID}" \
        --set gcpServiceAccount.secretName="service-account.json" \
        --set gcpServiceAccount.mountPath="/app/keys" \
        --set gcpServiceAccount.fileName="service-account.json"

    # -------------------------
    # Deploy user frontend (Docker Hub)
    # -------------------------
    - |
      helm upgrade --install esmael-user-frontend ./helm/user_frontend \
        --wait --timeout "$HELM_TIMEOUT" \
        --set image.repository="${USER_FRONTEND_REPO}" \
        --set image.tag="${USER_FRONTEND_TAG}" \
        --set env.VITE_API_URL="/api" 
        

    # -------------------------
    # Deploy admin backend (Docker Hub)
    # -------------------------
    - |
      helm upgrade --install esmael-admin-backend ./helm/admin_backend \
        --wait --timeout "$HELM_TIMEOUT" \
        --set image.repository="${ADMIN_BACKEND_REPO}" \
        --set image.tag="${ADMIN_BACKEND_TAG}" \
        --set env.CHUNK_URL="${CHUNK_URL:-}" \
        --set env.EMBEDDING_ENDPOINT="${EMBEDDING_ENDPOINT:-}" \
        --set env.VECTOR_DB_ENDPOINT="${VECTOR_DB_ENDPOINT:-}" \
        --set env.VECTOR_DB_ENDPOINT_UPSERT="${VECTOR_DB_ENDPOINT_UPSERT:-}" \
        --set env.DEPLOYED_INDEX_ID="${DEPLOYED_INDEX_ID:-}" \
        --set env.PROJECT_ID="${PROJECT_ID:-}" \
        --set env.REGION="${REGION:-}" \
        --set env.MEMORY_STORE_HOST="${MEMORY_STORE_HOST:-redis}" \
        --set env.MEMORY_STORE_PORT="${MEMORY_STORE_PORT:-6379}" \
        --set env.LLM_ENDPOINT="${LLM_ENDPOINT}" \
        --set env.LLM_MODEL_ID="${LLM_MODEL_ID}" \
        --set gcpServiceAccount.secretName="service-account.json" \
        --set gcpServiceAccount.mountPath="/app/keys" \
        --set gcpServiceAccount.fileName="service-account.json"

    # -------------------------
    # Deploy admin frontend (Docker Hub)
    # -------------------------
    - |
      helm upgrade --install esmael-admin-frontend ./helm/admin_frontend \
        --wait --timeout "$HELM_TIMEOUT" \
        --set image.repository="${ADMIN_FRONTEND_REPO}" \
        --set image.tag="${ADMIN_FRONTEND_TAG}" \
        --set env.VITE_API_URL="/api" 
        

    # -------------------------
    # Post-deploy notes: in OpenShift you might want to force imagePullPolicy or add imagePullSecrets
    # If your Docker Hub images are private, create an imagePullSecret in the target namespace and pass:
    #   --set image.pullSecrets[0].name=<your-secret-name>
    # in the helm commands above (or update chart values accordingly).
    # -------------------------

  environment:
    name: osd/sandbox

  rules:
    # run automatically only on the main branch
    - if: '$CI_COMMIT_REF_NAME == "develop"'
      when: manual 

    # otherwise never run this job
    - when: never
